###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://elasticbeanstalk-us-east-1-215550999357.s3.amazonaws.com/cms/secure/private_key.txt"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      MIIGLjCCBRagAwIBAgIRAN/bybAWGlVhB1YIJ0s+lrgwDQYJKoZIhvcNAQELBQAw
      gY8xCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO
      BgNVBAcTB1NhbGZvcmQxGDAWBgNVBAoTD1NlY3RpZ28gTGltaXRlZDE3MDUGA1UE
      AxMuU2VjdGlnbyBSU0EgRG9tYWluIFZhbGlkYXRpb24gU2VjdXJlIFNlcnZlciBD
      QTAeFw0yMDAxMDUwMDAwMDBaFw0yMjAxMDQyMzU5NTlaMBcxFTATBgNVBAMMDCou
      cXVhbmRhLmRldjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALjrc8p4
      SAMpdbnKWvmesvzlorTXaeHsqrFsT+frNUwIl9gsqDCb9CaCR+4UuXbgdG6635RF
      tIjCAmU9onmRB1RYUpzAnD8iQ1do9z06VigiVFIb78CpXsO8gW6t//fzs6OAO1/O
      TOXFzJRSXU5sWCIrbjVD7lXaz8RDjpxqFLRskYuAt2JHcPIot9Zjj2Wq+mCChWbQ
      U8L0zCKdeyS5ZS0LbnvFrFqY2f32GzhiKDIXsIJbR/ONkT94THHrJ7yaRDnxlKU1
      +HmG1pxLnEcMbv4Yjiof89OEdgA0uNVtD/8XCWBhJaADLAYwJhj4oKP4U/q0qrGv
      ciz7WC45BwZncK0CAwEAAaOCAvowggL2MB8GA1UdIwQYMBaAFI2MXsRUrYrhd+mb
      +ZsF4bgBjWHhMB0GA1UdDgQWBBRoWiJp6T8V5OVMLvDpssJx7UrzmDAOBgNVHQ8B
      Af8EBAMCBaAwDAYDVR0TAQH/BAIwADAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYB
      BQUHAwIwSQYDVR0gBEIwQDA0BgsrBgEEAbIxAQICBzAlMCMGCCsGAQUFBwIBFhdo
      dHRwczovL3NlY3RpZ28uY29tL0NQUzAIBgZngQwBAgEwgYQGCCsGAQUFBwEBBHgw
      djBPBggrBgEFBQcwAoZDaHR0cDovL2NydC5zZWN0aWdvLmNvbS9TZWN0aWdvUlNB
      RG9tYWluVmFsaWRhdGlvblNlY3VyZVNlcnZlckNBLmNydDAjBggrBgEFBQcwAYYX
      aHR0cDovL29jc3Auc2VjdGlnby5jb20wIwYDVR0RBBwwGoIMKi5xdWFuZGEuZGV2
      ggpxdWFuZGEuZGV2MIIBfgYKKwYBBAHWeQIEAgSCAW4EggFqAWgAdQBGpVXrdfqR
      IDC1oolp9PN9ESxBdL79SbiFq/L8cP5tRwAAAW92uSCcAAAEAwBGMEQCIHeFm+UY
      POL4jhvmVzhUILNF82L1kNH0Z5iVoySN1cmUAiBbgGm4ZZ2utCpiWWFCtIH5Q1ji
      /WVBiraQUDVtI+778AB3AG9Tdqwx8DEZ2JkApFEV/3cVHBHZAsEAKQaNsgiaN9kT
      AAABb3a5IHEAAAQDAEgwRgIhAMm2j/wW0gt+IA6zYhnL4b2GOGiCcAjbWa5Pz8CG
      nStnAiEApKJCmZOBYKDSq/FvJUN8N8WDTI1N2FDnXVar67pUdlkAdgAiRUUHWVUk
      VpY/oS/x922G4CMmY63AS39dxoNcbuIPAgAAAW92uSB5AAAEAwBHMEUCIHS4R830
      4lAdelAn5mGrGtjDPfCkZNYLv8jF7ysdoJN9AiEAgR4FKmQF46dfZRkuTHXQTDZ7
      5q8pHf740NSCY3gNxiUwDQYJKoZIhvcNAQELBQADggEBAAM7KwwA3yC4VyfQUyYt
      l5nccXqorClmkAGVyn7TDTGcc5aU+bQUFmuYaXc56T/rSuY6/l3a+Dytw8Ua0bCy
      wlKZvv4V43u/vrPZkgt1wJNQyYNfBEaNYQZ6ear+W3BO8eJfW+GNdZa+TurW+Kyh
      V4px3z6toZHJ23ilVKufOlUZuc2qcNC4TdCHTtmceBDPLHNnsKfGFRY4+yTFJF84
      q0mdT3v+42LSPvrinEp0h2tP5sTFI4tasV0Q+agBhIjXkv9SPEJjdOtMD+r2piQR
      F4LN4YprYalHeDedLIviT2ESau6Qn0J7x+fs74vj+Qi2trM9i4LSbBQtGYRWtOG/
      VU4=
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS server

      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
          ssl_prefer_server_ciphers   on;
          
          location / {
              proxy_pass  http://nodejs;
              proxy_set_header   Connection "upgrade";
              proxy_http_version 1.1;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Real-IP       $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          }
      }

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"
